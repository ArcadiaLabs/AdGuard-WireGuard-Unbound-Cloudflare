<p align="center">
 <img src="https://img.shields.io/badge/License-MIT-blue.svg">
 <img src="https://badges.frapsoft.com/os/v3/open-source.svg?v=103">
 <img src="http://ForTheBadge.com/images/badges/built-with-love.svg">
 <img src="https://img.shields.io/badge/badges-awesome-green.svg">
 <img src="https://img.shields.io/badge/Stay-Safe-red?logo=data:image/svg%2bxml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgNTEwIDUxMCIgaGVpZ2h0PSI1MTIiIHZpZXdCb3g9IjAgMCA1MTAgNTEwIiB3aWR0aD0iNTEyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnPjxnPjxwYXRoIGQ9Im0xNzQuNjEgMzAwYy0yMC41OCAwLTQwLjU2IDYuOTUtNTYuNjkgMTkuNzJsLTExMC4wOSA4NS43OTd2MTA0LjQ4M2g1My41MjlsNzYuNDcxLTY1aDEyNi44MnYtMTQ1eiIgZmlsbD0iI2ZmZGRjZSIvPjwvZz48cGF0aCBkPSJtNTAyLjE3IDI4NC43MmMwIDguOTUtMy42IDE3Ljg5LTEwLjc4IDI0LjQ2bC0xNDguNTYgMTM1LjgyaC03OC4xOHYtODVoNjguMThsMTE0LjM0LTEwMC4yMWMxMi44Mi0xMS4yMyAzMi4wNi0xMC45MiA0NC41LjczIDcgNi41NSAxMC41IDE1LjM4IDEwLjUgMjQuMnoiIGZpbGw9IiNmZmNjYmQiLz48cGF0aCBkPSJtMzMyLjgzIDM0OS42M3YxMC4zN2gtNjguMTh2LTYwaDE4LjU1YzI3LjQxIDAgNDkuNjMgMjIuMjIgNDkuNjMgNDkuNjN6IiBmaWxsPSIjZmZjY2JkIi8+PHBhdGggZD0ibTM5OS44IDc3LjN2OC4wMWMwIDIwLjY1LTguMDQgNDAuMDctMjIuNjQgNTQuNjdsLTExMi41MSAxMTIuNTF2LTIyNi42NmwzLjE4LTMuMTljMTQuNi0xNC42IDM0LjAyLTIyLjY0IDU0LjY3LTIyLjY0IDQyLjYyIDAgNzcuMyAzNC42OCA3Ny4zIDc3LjN6IiBmaWxsPSIjZDAwMDUwIi8+PHBhdGggZD0ibTI2NC42NSAyNS44M3YyMjYuNjZsLTExMi41MS0xMTIuNTFjLTE0LjYtMTQuNi0yMi42NC0zNC4wMi0yMi42NC01NC42N3YtOC4wMWMwLTQyLjYyIDM0LjY4LTc3LjMgNzcuMy03Ny4zIDIwLjY1IDAgNDAuMDYgOC4wNCA1NC42NiAyMi42NHoiIGZpbGw9IiNmZjRhNGEiLz48cGF0aCBkPSJtMjEyLjgzIDM2MC4xMnYzMGg1MS44MnYtMzB6IiBmaWxsPSIjZmZjY2JkIi8+PHBhdGggZD0ibTI2NC42NSAzNjAuMTJ2MzBoMzYuMTRsMzIuMDQtMzB6IiBmaWxsPSIjZmZiZGE5Ii8+PC9nPjwvc3ZnPg==">


<h2 align="center"><img src="https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/assets/images/awcu.gif" width= "700"></h2>

</p>
 <p align="center">
     <a href="https://img.shields.io/github/stars/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=FFD700&style=for-the-badge" alt="GitHub Repo stars">
         <img src="https://img.shields.io/github/stars/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=FFD700&style=for-the-badge"></a>
     <a href="https://img.shields.io/github/forks/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=00a671&style=for-the-badge" alt="GitHub forks">
         <img src="https://img.shields.io/github/forks/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=00a671&style=for-the-badge"></a>
     <a href="https://img.shields.io/github/watchers/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=9700b2&style=for-the-badge" alt="GitHub watchers">
         <img src="https://img.shields.io/github/watchers/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=9700b2&style=for-the-badge"></a>
</p>

<div align="center">
Translate Site | Traducir sitio  | ÁøªËØëÁΩëÁ´ô | Traduire le site | –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–∞–π—Ç | ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶ ‡§∏‡§æ‡§á‡§ü
<br><a href="https://chrome.google.com/webstore/detail/google-translate/aapbdbdomjkkjkaonfhkkikfgjllcleb?hl=en"><img src="https://www.vectorlogo.zone/logos/google_chrome/google_chrome-icon.svg" width=20px height=20px></a>&nbsp;<a href="https://addons.mozilla.org/en-US/firefox/addon/traduzir-paginas-web/"><img src="https://www.vectorlogo.zone/logos/firefox/firefox-icon.svg" width=20px height=20px></a> <a href="https://addons.opera.com/en/extensions/details/translator/"><img src="https://www.vectorlogo.zone/logos/opera/opera-icon.svg" width=20px height=20px></a></div> 

<h1 align="center">Features</h1>

<div align="center"> 
 
_<a href="https://github.com/AdguardTeam/AdGuardHome"><b>AdGuard Home</b></a> or <a href="https://github.com/pi-hole/pi-hole"><b>Pi-hole</b></a>_</br>Block banners, pop-ups and video advertisements network-wide

 _<a href="https://www.wireguard.com/"><b>WireGuard</b></a> or <a href="https://openvpn.net/"><b>OpenVPN</b></a>_</br>A VPN server accessible from public networks (IPv4 & IPv6)

_<a href="https://www.nlnetlabs.nl/projects/unbound/about/"><b>Unbound</b></a> or <a href="https://www.knot-resolver.cz/"><b>Knot</b></a>_</br>A validating, recursive, caching DNS resolvers (DoT)

_<a href="https://dnsprivacy.org/dns_privacy_daemon_-_stubby/about_stubby/"><b>Stubby</b></a>_</br>DNS queries are sent to resolvers over an encrypted TLS connection providing increased privacy

 _<a href="https://github.com/cloudflare/cloudflared"><b>Cloudflared Tunnel</b></a>_</br>A tunneling daemon that proxies traffic from a DNS network to your origins(DoH)

_<a href="https://dnscrypt.info/"><b>DNScrypt</b></a>_</br>Modern encrypted DNS protocols such as DNSCrypt v2, DNS-over-HTTPS, Anonymized DNSCrypt and oDoH (Oblivious DoH)
 
#
</div> 
<p align="right">
<i>All software are free, open-source and&nbsp;self-hosted&nbsp;</i></br><a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/wiki/About"><b>ABOUT</b></a> | <a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/discussions/17"><b>FAQ</b></a> | <a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki"><b>WIKI</b></a> | <a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/discussions"><b>DISCUSS</b></a>

<h3 align="left">DNS query speed üß™</h3>
<a href="https://docs.oracle.com/en-us/iaas/Content/DNS/Tasks/testingdnsusingdig.htm">BIND'S dig tool</a> results from google.com servers:

 - AdGuard default DNS resolvers - `60-70 msec`
 - Public Cloudflare/Quad9/Google DNS Resolvers - `50-70 msec`
 - Self-hosted setup - `5-10 msec`
 > **Note** Orginally `0 msec` but multiple blocklist with _excessive_ urls slow down lowend devices affecting DNS speed. This result was tested on a 1GB | 1.4GH ARM architecture. Blocklists used [<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-DNScrypt/blob/beb05c3a4b74a675dc88c43bcea41b08d00a04f3/bulkurls.py#L20"><b>click here</b></a>].
<details><summary>üé• Preview</summary>
<p>

AdGuard default <b><i>vs</i></b> Self-hosted:

https://user-images.githubusercontent.com/18756975/150230438-b767e86f-4e18-4791-b5fe-0813615a37a3.mp4

Public Cloudflare/Quad9/Google:</br>
<i>(same results if addresses are added manually in a system's network DNS fields)</i>

https://user-images.githubusercontent.com/18756975/150319049-3d8acdc9-624f-4b60-8ee2-b80227522252.mp4

</p>
 </details>
 
#
# Table of contents
 
 - [Requirements](#requirements)
 - [Install Raspberry Pi OS](#install-raspberry-pi-os-) <img src="https://www.vectorlogo.zone/logos/raspberrypi/raspberrypi-icon.svg" width=20px height=20px>
   - [Access Pi OS with SSH](#access-pi-os-with-ssh)
 - [Install AdGuard Home](#install-adguard-home-) <img src="https://www.vectorlogo.zone/logos/adguard/adguard-icon.svg" width=20px height=20px>
   - [Setup devices to work with Adguard](#setup-devices-to-work-with-adguard)
   - [Updating Adguard](#updating-adguard)
   - [Setting up AdGuard blocklist](#setting-up-adguard-blocklist)
     - [Add/Remove multiple URLs](#addremove-multiple-urls)
   - [Uninstall AdGuard](#uninstall-adguard)
   - [Install SSL certificate](#install-ssl-certificate)
   - [Install Pi-hole](#install-pi-hole-as-an-alternativeclick-here) <img src="https://upload.wikimedia.org/wikipedia/en/1/15/Pi-hole_vector_logo.svg" width=21px height=21px>
 - [Install Unbound](#install-unbound-) <img src="https://www.vectorlogo.zone/logos/nlnetlabsnl_unbound/nlnetlabsnl_unbound-icon.svg" width=20px height=20px>
 - [Install Knot](#install-knot-resolver-as-an-alternativeclick-here) <img src="https://www.vectorlogo.zone/logos/knot-resolvercz/knot-resolvercz-icon.svg" width=20px height=20px>
 - [Setup DNS security](#setup-dns-security-)
   - [Configure DoH/oDoH](#configure-dohodoh)
     - [DNScrypt proxy](#dnscrypt-proxyclick-here) <img src="https://i.imgur.com/lEHVsn3.png" width=20px height=20px>
   - [Configure DoT on Unbound](#configure-dot-on-unbound)
     - [Configure Stubby and Unbound](#configure-stubby-and-unbound)
   - [Configure AdGuard with (DoH/DoT/oDoH)](#configure-adguard-with-dohdotodoh)
     - [Stable DNS resolving](#stable-dns-resolving)
       - [Windows](#windows)
       - [Android](#android)
 - [Install WireGuard](#install-wireguard-) <img src="https://www.vectorlogo.zone/logos/wireguard/wireguard-icon.svg" width=20px height=20px>
   - [Connecting VPN to Android/IOS Phone](#connecting-vpn-to-androidios-phone)
   - [Connecting VPN to Windows](#connecting-vpn-to-windows)
   - [Install OpenVPN](#install-openvpn-as-an-alternativeclick-here)</a> <img src="https://i.imgur.com/Agstbe5.png" width=20px height=20px>
   - [Configure WireGuard with adblocking & DNS security](#configure-wireguard-with-adblocking--dns-security)
     - [Limit traffic](#limit-traffic)
     - [Disable all IPv6](#disable-all-ipv6)
   - [Test Vpn](#test-vpn) <img src="https://i.imgur.com/6Yf8Zra.png" width=20px height=20px>
 - [Repository Resources](#repository-resources)

#
# Requirements
 
This tutorial is installed on a Raspberry Pi with Debian OS. Other Linux <a href="https://distrowatch.com/dwres.php?resource=popularity">operating system</a><i>(ùüπùü∏/ùüºùü∫bit)</i>, <a href="https://en.wikipedia.org/wiki/Category:Single-board_computers">hardware</a> or <a href="https://www.google.com/search?q=cheap+cloud+hosting&client=firefox-b-d&sxsrf=ALiCzsYoJfYnpJOA1nwDPd1eX9mA-z_ozg%3A1662213729520&ei=YV4TY_OzH8y_kvQPkb-_sAE&ved=0ahUKEwiz6I3X5Pj5AhXMn4QIHZHfDxYQ4dUDCA0&oq=cheap+cloud+hosting&gs_lcp=Cgdnd3Mtd2l6EAxKBAhBGABKBAhGGABQAFgAYABoAHABeACAAQCIAQCSAQCYAQA&sclient=gws-wiz">cloud service</a> can be used.</br>_(Raspberry Pi OS is most simple and recommended for Pi. For more experience users, <a href="https://dietpi.com/">DietPi</a> OS is also recommended)_

   - A Raspberry Pi 3 or 4 version
   - A router that supports port forwarding(most can)
   - MicroSD USB card reader
   - MicroSD card (8GB or bigger, at least Class 4)
   - Ethernet cable
   - (Optional if using monitor) MicroHDMI-(RPi 4) or HDMI-(RPi 3)

#
<h1 align="center"><b><i>Install Raspberry Pi OS</b></i> </h1>

Raspberry Pi OS comes in desktop and lite versions(use lite for <a href="https://www.google.com/search?q=What+is+a+headless+operating+system%3F&client=firefox-b-d&sxsrf=APq-WBvlqMZasn_klYxS5HZmhKQlduKYuQ%3A1650123816301&ei=KORaYtz7EYOdwbkP74G16AE&ved=0ahUKEwjcr5-f9pj3AhWDTjABHe9ADR0Q4dUDCA0&uact=5&oq=What+is+a+headless+operating+system%3F&gs_lcp=Cgdnd3Mtd2l6EAMyCAghEBYQHRAeOgcIABBHELADSgQIQRgASgQIRhgAUMEBWMEBYNAEaAFwAXgAgAFqiAFqkgEDMC4xmAEAoAECoAEByAEIwAEB&sclient=gws-wiz">headless</a> mode). It can be accessed with a monitor/keyboard/mouse or connect via <a href="https://www.google.com/search?q=What+is+SSH+in+Linux%3F&client=firefox-b-d&sxsrf=APq-WBsiHvek7g0OrBHWDbEy-x7m-B6O3Q%3A1650481751310&ei=V1pgYoHNEs-uwbkPtI25mAI&ved=0ahUKEwjB1PrTq6P3AhVPVzABHbRGDiMQ4dUDCA0&uact=5&oq=What+is+SSH+in+Linux%3F&gs_lcp=Cgdnd3Mtd2l6EAMyBggAEBYQHjIGCAAQFhAeMgYIABAWEB4yBggAEBYQHjIGCAAQFhAeMgYIABAWEB4yBggAEBYQHjIGCAAQFhAeMgYIABAWEB4yBggAEBYQHjoHCCMQsAMQJzoHCAAQRxCwAzoHCAAQsAMQQzoKCAAQ5AIQsAMYAToPCC4Q1AIQyAMQsAMQQxgCSgQIQRgASgQIRhgBUM8IWM8IYJAMaAFwAXgAgAFxiAFxkgEDMC4xmAEAoAECoAEByAERwAEB2gEGCAEQARgJ2gEGCAIQARgI&sclient=gws-wiz">ssh</a> from a terminal.<br>Raspberry Pi OS <b>cannot</b> be setup through the <a href="https://www.raspberrypi.com/news/raspberry-pi-bullseye-update-april-2022/#Headless%20setup">wizard</a> anymore, the <a href="https://www.raspberrypi.com/news/raspberry-pi-imager-imaging-utility/">Imager</a> utility is needed to preconfigure an image user account.

 * Install Raspberry Pi Imager: https://www.raspberrypi.com/software/

 * Download Raspberry Pi OS image: https://www.raspberrypi.org/software/operating-systems/

- Open Pi Imager tool and configure settings in advanced options. Choose image, select microSD card and click `Write`.

<p align="center">
 <img src="https://i.imgur.com/S6pDPZv.png">
 
<i>Place SD card into the Raspberry Pi, plug in Ethernet cable and boot up</i>

## Access Pi OS with SSH

 * Wait for a minute for Pi's first boot up

 * Open browser and login router's admin panel(default <a href="https://www.google.com/search?client=firefox-b-d&q=find+default+gateway+address">gateway</a> address)
 
 * Find list of all devices connected to network and copy the IP address of the Raspberry Pi. It will most likely have the hostname `raspberrypi`

 * Open terminal on host machine <i>(Windows powershell or raspcontroller for Android can be used)</i>.

Type the following command:
```
ssh pi@pi's IP address
```
<i>Use right mouse button to paste text in Windows powerShell</i>.

Type ‚Äúyes‚Äù for fingerprint question, and enter password.

<p align="center">
 <img src="https://i.imgur.com/Wf30jxG.jpg">

Run in terminal:
```
sudo apt update -y && sudo apt upgrade -y
```
*_Reboot when finished_*
```
sudo reboot
```
**[‚¨Ü Return to contents ‚¨Ü](#table-of-contents)**

#
<h1 align="center"><b><i>Install AdGuard Home</b></i> </h1>

Installation scripts are from <a href="https://github.com/AdguardTeam/AdGuardHome/blob/master/README.md">AdGuard Home</a> main project. Follow to keep updated.<br>
Run one of the following command in terminal:

Stable:
```
curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v
```
Beta - testing version of AdGuard Home. More or less stable versions:
```
curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -c beta
```
Edge - newest version of AdGuard Home. New updates are pushed to this channel daily and might not be stable:
```
curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -c edge
```
 * When installation is finished, it will show the `links` to your AdGuard home page(Get Started) in terminal

 * Choose `Eth0` in **Listen Interfaces** option
 
 <p align="center">
  <img src="https://i.imgur.com/5W70PLb.png" width=580px height=650px>

 * Set up username&password and then login admin panel

> **Note**
In general settings, set "Query logs retention" to `24 hours`. (I read that for some people logs fill up which slows down Pi and needing a reboot)

## Setup devices to work with AdGuard

 - For Android/Apple, go to WiFi advanced settings and select static option. In `DNS 1` field enter "Pi's IP" address

 <p align="center">
  <img src="https://i.imgur.com/nxpiqDw.jpg" width=450px height=580px>

 - For PC/Windows

    - <i>IPv4</i>

    Go to network settings / change adapter options, right click in properties and select "Internet Protocol Version 4(TCP/IPv4)". Enter Pi's IP address in `Preferred DNS` server.

    - <i>IPv6 (needed for `DoH`/`DoT`/`oDoH` to detect if using it)</i>

     Go to "Internet Protocol Version 6(TCP/IPv6)" Enter `::1`

<p align="center">
 <img src="https://i.imgur.com/8gsDk3z.jpg">

## Updating AdGuard
 
AdGuard Home can be updated from its user interface or <a href="https://github.com/AdguardTeam/AdGuardHome/wiki/FAQ#how-to-update-adguard-home-manually">manually</a> from command line which I recommend for now. <br>
_Use script constructed with update commands[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/AdGuard-Home-update-script"><b>click here</b></a>]_.

## Setting up AdGuard blocklist

In AdGuard homepage under filters, select DNS blocklist section for adding URLs.

<p align="center">
 <img src="https://i.imgur.com/xAlbKPW.png">

<p align="center">
<b>Ultimate blocklists</b>
<br>
<a href="https://github.com/T145/black-mirror"><img src="https://raw.githubusercontent.com/T145/black-mirror/master/.github/images/logo.png" width=220px height=60px></a>
<br>
Automatically maintained malicious host blacklists and false-positive whitelists</p>

üëäBIG THANKSüëä to <a href="https://github.com/T145"><b>T145</b></a><br>
Sources[<a href="https://github.com/T145/black-mirror/blob/master/SOURCES.md"><b>click here</b></a>]
<b>
</b>

> **Note**
Some lists can block important web content. To unblock, go to "Query Log" section, hover cursor over that specific query<i>(look for client IP & time)</i> to show _unblock_ option. The links is automatically created in "Custom filtering rules" example: `@@||bitly.com^$important`(can add the websites manually as well).


## Add/Remove multiple URLs

Only one URL can be added at a time in DNS blocklist with AdGuard for now, but there is a python script to add multiple URLs at once.<br>
Create a new python file(bulkurls.py):
```
nano bulkurls.py
```  

Then copy and paste script text[<a href="https://raw.githubusercontent.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/main/bulkurls.py"><b>click here</b></a>]. Set `your AdGuard credentials` and save (control+x then y then enter).
 
> **Note**
_If using **DietPi** install `sudo apt-get install python3-pip -y && pip install requests` for it is not installed by default._
  
To run : `sudo python3 bulkurls.py`<br>
_(Reboot when finished)_

To **remove** change `add` in <a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/62ba01ed8ed3a5bc5294b9fe7ee38c3e83ae1b86/bulkurls.py#L150">second of last line</a> to `remove` in bulkurls.py file.<br>
Or just change it from command line in terminal:
```
sed -i 's/add_url/remove_url/g' bulkurls.py

# Revert
sed -i 's/remove_url/add_url/g' bulkurls.py
```

## Uninstall AdGuard

Run this <a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/main/assets/scripts/remove_adguard.sh">script</a> from repo through network using <a href="https://www.google.com/search?q=What+does+cURL+actually+do%3F&client=firefox-b-d&sxsrf=ALiCzsbIVTaRzlDt3jC6H5lirpsy2S0LoA%3A1654699803869&ei=G7egYprXNNbawbkP38uIqAE&ved=0ahUKEwja0JOQjZ74AhVWbTABHd8lAhUQ4dUDCA0&uact=5&oq=What+does+cURL+actually+do%3F&gs_lcp=Cgdnd3Mtd2l6EAMyBQghEKABMgUIIRCgATIFCCEQoAEyBQghEKABMggIIRAeEBYQHTIICCEQHhAWEB0yCAghEB4QFhAdMggIIRAeEBYQHTIICCEQHhAWEB0yCAghEB4QFhAdOgcIIxCwAxAnOgcIABBHELADSgQIQRgASgQIRhgAUI8DWI8DYNgGaAFwAXgAgAGcAYgBnAGSAQMwLjGYAQCgAQKgAQHIAQnAAQE&sclient=gws-wiz">curl</a> in terminal:
```
curl -s -L https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/assets/scripts/remove_adguard.sh | sh
```

## Install SSL certificate

If using AdGuard Home on a `VPS(Virtual private server)`, get a <a href="https://www.google.com/search?q=What+is+purpose+of+SSL+certificate%3F&client=firefox-b-d&sxsrf=APq-WBsi9wVR8QaPcOuMXEpKVMqtOxrI-A%3A1650799271342&ei=pzJlYvDEFJbUkPIP48mPkAY&ved=0ahUKEwiwtKfByqz3AhUWKkQIHePkA2IQ4dUDCA0&uact=5&oq=What+is+purpose+of+SSL+certificate%3F&gs_lcp=Cgdnd3Mtd2l6EAMyBggAEBYQHjIGCAAQFhAeOgcIABBHELADOgcIABCwAxBDOgoIABDkAhCwAxgBOhUILhDHARCvARDUAhDIAxCwAxBDGAI6EgguEMcBENEDEMgDELADEEMYAkoECEEYAEoECEYYAVC7AVi7AWDnBGgBcAF4AIABbYgBbZIBAzAuMZgBAKABAqABAcgBE8ABAdoBBggBEAEYCdoBBggCEAEYCA&sclient=gws-wiz">SSL certificate</a> to make connection secure and data safe[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Create-auto-renewal-SSL-certificate"><b>click here</b></a>]. In this case your DNS resolver(AdGuard Home) resides outside your network, and your DNS requests have better protection from the third parties.

### _Install Pi-hole as an alternative[<a href="https://github.com/pi-hole/pi-hole/#one-step-automated-install"><b>click here</b></a>]_

**[‚¨Ü Return to contents ‚¨Ü](#table-of-contents)**

#
<h1 align="center"><b><i>Install Unbound</b></i> </h1>

> **Note**
Before installing other DNS resolvers, it is a good idea to turn off <a href="https://www.freedesktop.org/software/systemd/man/systemd-resolved.service.html">systemd-resolved</a> - DNSStubListener(<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/issues/27">issue#27</a>).

`OPTIONAL:` Installing via the package manager is the easiest option with automatic updates and stable versions. The downside is that it can be outdated for some distributions or not have all the compile-time options included that you want.<br>**Building and compiling** Unbound yourself ensures that you have the latest version and all the compile-time options you desire[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Build-Unbound-from-source"><b>click here</b></a>].

For the version from package manager, run the following command in terminal:
```
sudo apt install unbound -y
```
For recursively querying a host that is not cached as an address, the resolver needs to start at the top of the server tree and query the root servers, to know where to go for the top level domain for the address being queried. Unbound comes with default built-in hints.<br>Download latest:
```
wget -O root.hints https://www.internic.net/domain/named.root && sudo mv root.hints /var/lib/unbound/
```

This needs to update every 6 months using <a href="https://www.google.com/search?q=How+does+cron+job+work%3F&client=firefox-b-d&sxsrf=ALiCzsbaAmCCZqLJt2cOtQ3UXn7wxrWD3Q%3A1651353477111&ei=hadtYt-vBoavqtsP_fGX4Ak&ved=0ahUKEwifhpuL27z3AhWGl2oFHf34BZwQ4dUDCA0&uact=5&oq=How+does+cron+job+work%3F&gs_lcp=Cgdnd3Mtd2l6EAMyBggAEBYQHjoHCAAQRxCwAzoHCAAQsAMQQ0oECEEYAEoECEYYAFDTAVjTAWDRBmgBcAF4AIABfYgBfZIBAzAuMZgBAKABAqABAcgBCcABAQ&sclient=gws-wiz">cron job</a>.

Enter in command line `crontab -e`, it will ask select an editor(choose 1), paste these lines at the bottom of crontab and save (control+x then y then enter):
```
1 0 1 */6 * wget -O root.hints https://www.internic.net/domain/named.root
2 0 1 */6 * sudo mv root.hints /var/lib/unbound/
```
> **Note**
_If using **DietPi**, install resolvconf and restart unbound-resolvconf.service to set default nameserver to 127.0.0.1:_

>     sudo apt-get install resolvconf -y && sudo systemctl restart unbound-resolvconf.service
 

<p align="center">
 <img src="https://i.imgur.com/26ro62t.jpg">
 
### _Install Knot Resolver as an alternative[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Install-Knot-Resolver"><b>click here</b></a>]_

**[‚¨Ü Return to contents ‚¨Ü](#table-of-contents)**

#    
<h1 align="center"><b><i>Setup DNS Security</b></i> </h1>

## Configure DoH/oDoH
<b>Option 1 (Simple)</b><br><br>Cloudflare Tunnel[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Install-Cloudflared-Tunnel-(DoH)"><b>click here</b></a>]:<br>(DNS over HTTPS only)

<b>Option 2 (Advanced)</b><h4>DNScrypt proxy[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Install-DNScrypt-proxy-(DoH)(oDoH)(Anonymized-DNS)"><b>click here</b></a>]:</h4>- DNS over HTTPS <br>- Oblivious DNS Over HTTPS (experimental)<br>- Anonymized DNS

_<a href="https://blog.cloudflare.com/oblivious-dns/">Oblivious DNS Over HTTPS</a></h4>(oDoH) is a newly proposed open-source DNS standard built by engineers from Cloudflare, Apple, and Fastly which is supposed to increase the privacy of already existing DNS Over HTTPS_.<br>
_<a href="https://github.com/DNSCrypt/dnscrypt-proxy/wiki/Anonymized-DNS">Anonymized DNS</a> is a lightweight alternative to Tor and SOCKS proxies, dedicated to DNS traffic. They hide the client IP address to DNS resolvers, providing anonymity in addition to confidentiality and integrity._.

## Configure DoT on Unbound

Download unbound <a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/main/unbound.conf">configuration</a> file with DNS over TLS settings and move it to unbound folder.<br>
Enter in terminal:
```
wget https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/unbound.conf && sudo mv unbound.conf /etc/unbound/unbound.conf.d/
```
 - Choose DNS provider[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/DNS-Providers#unbound"><b>click here</b></a>]

## Configure Stubby and Unbound

Use Unbound for caching and Stubby as a <a href="https://www.google.com/search?q=How+does+TLS+proxy+work%3F&client=firefox-b-d&sxsrf=ALiCzsaNlPunZpYtzDVoVA6PVTkY6rOqyQ%3A1651275938995&ei=onhsYsqtPImRggez_K2oBA&ved=0ahUKEwjKhpSeurr3AhWJiOAKHTN-C0UQ4dUDCA4&uact=5&oq=How+does+TLS+proxy+work%3F&gs_lcp=Cgdnd3Mtd2l6EAMyBQghEKABMgUIIRCgATIFCCEQoAEyBQghEKABMggIIRAWEB0QHjIICCEQFhAdEB4yCAghEBYQHRAeMggIIRAWEB0QHjIICCEQFhAdEB4yCAghEBYQHRAeOgcIABBHELADSgQIQRgASgQIRhgAUMUBWMUBYMkHaAFwAXgAgAGfAYgBnwGSAQMwLjGYAQCgAQKgAQHIAQjAAQE&sclient=gws-wiz">TLS forwarder</a>(if **NOT** already using with DNScrypt).

`OPTIONAL:` **Building and compiling** Stubby yourself ensures that you have the latest version[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Build-Stubby-from-source"><b>click here</b></a>].

Install the version from package manager:
```
sudo apt install stubby -y
```
Download stubby <a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/main/stubby.yml">configuration</a> file and replace with default one in stubby folder:
```
wget https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/stubby.yml && sudo mv stubby.yml /etc/stubby/
```

 - Forward Stubby address in Unbound upstreams. Open `sudo nano /etc/unbound/unbound.conf.d/`<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/main/unbound.conf">`unbound.conf`</a> and uncomment Stubby addresses(remove # infront of lines [169](https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/68726b2c1e24d1940ac82775be9aa76748f564d2/unbound.conf#L169)&[170](https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/68726b2c1e24d1940ac82775be9aa76748f564d2/unbound.conf#L170))<br>Or do it from command line:
```
awk '{sub(/[#]forward-addr: 127.0.0.1@8053/,"forward-addr: 127.0.0.1@8053") || sub(/[#]forward-addr: ::1@8053/,"forward-addr: ::1@8053")}1' /etc/unbound/unbound.conf.d/unbound.conf > unbound.conf && sudo mv unbound.conf /etc/unbound/unbound.conf.d/
```
 - Choose DNS provider[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/DNS-Providers#stubby"><b>click here</b></a>]

> **Warning**
Stubby and DNScrypt **should not** be used together when both are set to run as a forwarder, else redundant caching will occur.

* Restart unbound & stubby and check status:
```
sudo systemctl restart unbound stubby ; systemctl status unbound stubby -l
```
<p align="center">
 <img src="https://i.imgur.com/7zIpWP2.jpg" width=650px height=370px>
 

## Configure AdGuard with `(DoH/DoT/oDoH)`

 * In AdGuard homepage under settings, select **DNS settings**

 * Delete everything from both _**Upstream**_ and _**Bootstrap DNS**_ server options and add the following for:

   - DNS over TLS(unbound/knot) : `127.0.0.1:53`
 
   - DNS over HTTPS/Oblivious DNS over HTTPS :
 
      - `127.0.0.1:5053`(cloudflared tunnel) 
      - `127.0.0.1:5353`(dnscrypt proxy)
 
   - TLS forwarder(stubby) : `127.0.0.1:8053` 

* `IMPORTANT:` Check "<a href="https://adguard.com/en/blog/in-depth-review-adguard-home.html#dns">Parallel Request</a>" option for DNS resolvers to work simultaneously.

<p align="center">
 <img src="https://i.imgur.com/iQRdMax.png" width=650px height=320px>

 * Then in DNS setting look for DNS cache configuration section and set cache size to `0` (caching is already handled by Unbound) and click apply.

<p align="center">
 <img src="https://i.imgur.com/TdzhNUo.png" width=650px height=320px>
 
Click apply and test upstreams

#### Stable DNS resolving
 
> **Note**
Help resolve multiple DNS servers on Windows system and Android browsers. Linux works fine</b><i>(tested on ubuntu)</i>

#### Windows 

 * Install Acrylic DNS Proxy: https://mayakron.altervista.org/support/acrylic/Home.htm

 * Go to `C:\Program Files (x86)\Acrylic DNS Proxy` and open `AcrylicConfiguration.ini` file. Delete everything and copy these settings[<a href="https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/AcrylicConfiguration.ini"><b>click here</b></a>], only change _**PrimaryServerAddres**_ to your Pi's address.

 * In same folder run `RestartAcrylicService.bat` & `PurgeAcrylicCacheData.bat`

 `TIP:` Troubleshoot IP/DNS Commands
  ```
 ipconfig /release
 ipconfig /renew
 ipconfig /flushdns
  ```
#### Android

 * In whatever browser is used, turn **off** `Use Secure DNS` option if available.

 *  Try adding Pi's IP address in 2nd DNS field.
 
 * Be aware conflicts can occur with custom rooted roms&kernels with build.prop DNS tweaks or apps/magisk module.

#### Now go to https://1.1.1.1/help in browser and these options should output 'Yes'. 
 - [x] Connected to 1.1.1.1
 - [x] DNS over HTTPS(DoH)
 - [x] DNS over TLS(DoT)
 - [ ] DNS over WARP
 <p align="center">
  <img src="https://i.imgur.com/ootfGYq.jpg" width=650px height=300px>

#### Other sites to check security
https://browserleaks.com/dns - should show all connected to "Cloudflare"

https://dnssec.vs.uni-due.de/ - should say "Yes, your DNS resolver validates DNSSEC signatures"
 
 https://dnscheck.tools/ - inspect your dns resolvers (DNSSEC using ECDSA P-256,DNSSEC using ECDSA P-384,DNSSEC using Ed25519)

**[‚¨Ü Return to contents ‚¨Ü](#table-of-contents)**

#
<h1 align="center"><b><i>Install WireGuard</b></i> </h1>

> **Warning**
**Before installing WireGuard**, if you do not have a <a href="https://www.google.com/search?client=firefox-b-d&q=static+IP">static IP</a> it will change dynamically from your internet service provider or from a router reboot. You will need to setup a dynamic DNS service with a hostname to keep automatically up-to-date with a  dynamic IP[**<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Create-a-DNS-domain-hostname"><b>click here</b></a>**]. Or else skip.<br>You also need to set up <a href="https://www.google.com/search?q=What+is+port+forwarding+used+for%3F&client=firefox-b-d&sxsrf=APq-WBuwPqGlPJ6N9_l6qpQ3e5sYoUxZAQ%3A1650219365125&ei=ZVlcYo6sB6SGwbkP8tGOwA8&ved=0ahUKEwjO8ryY2pv3AhUkQzABHfKoA_gQ4dUDCA0&uact=5&oq=What+is+port+forwarding+used+for%3F&gs_lcp=Cgdnd3Mtd2l6EAMyBggAEBYQHjoHCAAQRxCwAzoHCAAQsAMQQ0oECEEYAEoECEYYAFDMAVjMAWCBBWgBcAF4AIABbIgBbJIBAzAuMZgBAKABAqABAcgBCsABAQ&sclient=gws-wiz">port forwarding</a> on your router so you can access WireGuard network anywhere like a coffee shop hotspot and even from mobile data tethering.

TYPE | VALUE     
------------ | -------------
Device | Raspberry Pi's hostname or IP
Protocol | UDP
Port range | 51820-51820
Outgoing port | 51820
Permit Internet access(if have) | yes 

Example of my router port settings:

<p align="center">
 <img src="https://i.imgur.com/9LBEk1i.jpg" width="640" height="420">
</br>
Other router brands will have a different interface look. Google search it for help. If you cannot connect from a outside network that means your ISP has blocked outcoming connections, call them and ask nicely to unblock.

#
üëäBIG THANKSüëä for this installation script from <a href="https://github.com/Nyr/wireguard-install"><b>Nyr</b></a>. Follow to keep updated.<br>(<a href="https://www.pivpn.io/">PiVPN</a> script can also be used)

Run the following command in terminal:
```
wget https://git.io/wireguard -O wireguard-install.sh && sudo bash wireguard-install.sh
```
 * The script is going to ask for a Public IPv4/hostname for the VPN. If you have static IP then continue or else type the dynamic DNS hostname that you created from the <a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Dynamic-DNS-service">instructions</a>. For example:`trinibvpn.freeddns.org`

 * For port option `press enter` for default 51820, set client name and for DNS use option 3 (`1.1.1.1`) for now.

<p align="center">
 <img src="https://i.imgur.com/WUNZIK4.jpg">

 * Wait until the installation is finished and QR code to show, <b>don't close</b>. But if do, to `regenerate qrcode`, enter in terminal but replacing just the name `yourclientname.conf` file to yours: 
```
sudo cp /root/yourclientname.conf /home/pi && sudo qrencode -t ansiutf8 < yourclientname.conf
```
                                                                                             
> **Warning**
You will need to add a new client/user for each device used with the VPN<i>(cannot share 1 client to multiple devices)</i>. To add, re-run the script and create another user with different client name.

### _Install OpenVPN as an alternative[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Install-OpenVPN"><b>click here</b></a>]_

### Connecting VPN To Android/IOS Phone

Install the WireGuard app from Google Play or App Store:

WireGuard (Google Play): https://play.google.com/store/apps/details?id=com.wireguard.android

WireGuard (App Store): https://apps.apple.com/us/app/wireguard/id1441195209

Scan the QR code shown in the terminal with WireGuard app, select the `+ button` and use the option `Scan from QR code` to install configuration.

- Enable **kernel module backend** in settings

<p align="left">
 <img src="https://i.imgur.com/R4qbiOQ.jpg" width=250px height=350px>

### Connecting VPN to Windows

WireGuard for windows: https://download.wireguard.com/windows-client/wireguard-installer.exe

 * Create a `new text document` with any name on PC to copy over the text from WireGuard client configuration file.

 * To see text in client config file, type in terminal:
```
sudo cat /root/yourclientname.conf
```
 * Highlight all the text, copy and paste it in the txt file on PC and save. Then rename the extension from `txt` to `conf`. Now you have config file for that specific WireGuard client/user.

 * Import the config file to WireGuard (import from file option).

## Configure WireGuard with adblocking & DNS security

> **Note**
I think it might not make much of a difference to use DoT/DoH/oDoH with WireGuard security protocols. Though from my experience and in forums, it does not seem to cause any issues using them together. Mainly this is to achieve adblocking with a VPN on public networks.
 
 * In WireGuard app, select your tunnel name and select edit (pencil on top right)

 * Under DNS servers enter `Pi's IP`(IPv4 & IPv6) and save

<p align="center">
 <img src="https://i.imgur.com/UC0vWfE.jpg" width=450px height=500px>  

### Limit traffic

WireGuard will lose a fair percentage of internet speed from the process of tunneling through Linux system, to router and to devices. You need send traffic through your local network only for better speeds[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Limit-traffic-on-VPN"><b>click here</b></a>].

#
### Disable all IPv6

#### Disable IPv6 if you don't have it or don't want it[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/wiki/Disable-all-IPv6"><b>click here</b></a>]. In result if you have weak internet, disabling IPv6 can speed up dns records and request but have less security.

#
## Test VPN

How to know if WireGuard VPN is really working?

For **windows** download Wireshark: https://www.wireshark.org/#download

Once downloaded, use the application to inspect data packets where the protocol is set to the one used by WireGuard VPN. When a packet traffic is `encrypted`, it can be read  like this for example:
<p align="center">
 <img src="https://i.imgur.com/Tn4M47R.jpg">

For **android** use PCAPdroid: https://play.google.com/store/apps/details?id=com.emanuelef.remote_capture&hl=en&gl=US
                                                                                                                                
You should see all connections `closed` and status showing all `DNS port 53` and not any TLS port 443 connections from all apps. (open and use apps for PCAPdroid to scan)

**[‚¨Ü Return to contents ‚¨Ü](#table-of-contents)**

***

<b>ANY ISSUES, FIXES OR TIPS TO MAKE THESE PROJECTS BETTER PLEASE CONTRIBUTEü§ñ</b>


<p align="center">
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif"
<br> 
<br> 
<br> 

<p align="center">
 <img src="https://i.imgur.com/Q07E7SW.gif" width=500px height=30px>

<p align="center">
<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/stargazers"><img src="https://reporoster.com/stars/dark/trinib/AdGuard-WireGuard-Unbound-DNScrypt"></a>

<p align="center">
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif"</p>

#

## Repository Resources

https://github.com/AdguardTeam/AdGuardHome/wiki

https://docs.pi-hole.net/

https://developers.cloudflare.com/

https://unbound.docs.nlnetlabs.nl/en/latest/
 
https://knot-resolver.readthedocs.io/en/stable/#

https://dnsprivacy.org/dns_privacy_clients/
 
https://github.com/DNSCrypt/dnscrypt-proxy/wiki

https://github.com/Nyr/wireguard-install
     
https://github.com/T145/black-mirror
